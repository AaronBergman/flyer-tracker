<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{{ link.slug }} â€” Link Tracker</title>
    <link rel="icon" type="image/png" href="/static/icon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,400;12..96,600;12..96,700;12..96,800&family=JetBrains+Mono:wght@400;500&family=Source+Serif+4:ital,opsz,wght@0,8..60,400;0,8..60,600;1,8..60,400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9/dist/leaflet.css">
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>

<header>
    <div class="container">
        <div class="header-nav">
            <a href="/dashboard" class="back-link">&larr; All Links</a>
            <a href="/dashboard" class="logo">
                <img src="/static/icon.png" alt="" class="logo-icon">
                <span class="logo-text">Link Tracker</span>
            </a>
        </div>
    </div>
</header>

<main class="container">
    <div class="page-header animate-in">
        <h1 class="slug-title">{{ link.slug }}</h1>
        <div class="meta">
            {% if link.description %}<p><strong>Description:</strong> {{ link.description }}</p>{% endif %}
            <p><strong>Tracking URL:</strong> <code>{{ base_url }}/t/{{ link.slug }}</code></p>
        </div>
    </div>

    <div class="stats-grid animate-in animate-in-1">
        <div class="stat-card">
            <div class="stat-num">{{ scans | length }}</div>
            <div class="stat-label">Total Scans</div>
        </div>
        <div class="stat-card">
            <div class="stat-num">{{ unique_cities }}</div>
            <div class="stat-label">Unique Cities</div>
        </div>
        {% if scans %}
        <div class="stat-card">
            <div class="stat-num">{{ scans[-1].scanned_at.strftime('%b %d') }}</div>
            <div class="stat-label">First Scan</div>
        </div>
        <div class="stat-card">
            <div class="stat-num">{{ scans[0].scanned_at.strftime('%b %d') }}</div>
            <div class="stat-label">Latest Scan</div>
        </div>
        {% endif %}
    </div>

    {% if map_points %}
    <div class="animate-in animate-in-2">
        <h2>Scan Map</h2>
        <div id="map" class="map-container"></div>
    </div>
    {% endif %}

    <div class="animate-in animate-in-3">
        <div class="section-header">
            <h2>Scan Log</h2>
            <div class="actions">
                {% if scans %}
                <a href="/api/links/{{ link.slug }}/export" class="btn btn-outline">Export CSV</a>
                {% endif %}
                <button class="btn btn-danger" id="delete-btn">Delete</button>
            </div>
        </div>

        {% if scans %}
        <div class="table-wrap">
            <table>
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>City</th>
                        <th>Region</th>
                        <th>Country</th>
                        <th>Coordinates</th>
                    </tr>
                </thead>
                <tbody>
                    {% for scan in scans %}
                    <tr>
                        <td>{{ scan.scanned_at.strftime('%b %d, %H:%M') }}</td>
                        <td>{{ scan.ip_city or "\u2014" }}</td>
                        <td>{{ scan.ip_region or "\u2014" }}</td>
                        <td>{{ scan.ip_country or "\u2014" }}</td>
                        <td>
                            {% if scan.browser_lat %}
                                {{ "%.4f" | format(scan.browser_lat) }}, {{ "%.4f" | format(scan.browser_lng) }}
                                <span class="precise-tag">GPS</span>
                            {% elif scan.ip_lat %}
                                {{ "%.4f" | format(scan.ip_lat) }}, {{ "%.4f" | format(scan.ip_lng) }}
                                <span class="ip-tag">IP</span>
                            {% else %}
                                &mdash;
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="empty-state">No scans yet.</p>
        {% endif %}
    </div>
</main>

{% if map_points %}
<script src="https://unpkg.com/leaflet@1.9/dist/leaflet.js"></script>
<script>
(function () {
    var points = {{ map_points | tojson }};
    var map = L.map("map", { zoomControl: true });

    L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png", {
        attribution: '\u00a9 <a href="https://www.openstreetmap.org/copyright">OSM</a> \u00a9 <a href="https://carto.com/">CARTO</a>',
        maxZoom: 19,
        subdomains: "abcd",
    }).addTo(map);

    var markers = [];
    points.forEach(function (p) {
        var marker = L.circleMarker([p.lat, p.lng], {
            radius: p.precise ? 8 : 6,
            fillColor: p.precise ? "#4fad6a" : "#4d94c8",
            color: "rgba(255,255,255,0.35)",
            weight: 2,
            fillOpacity: 0.85,
        }).addTo(map);
        marker.bindPopup(
            "<b>" + p.city + "</b><br>" +
            p.time + "<br>" +
            (p.precise ? "GPS (precise)" : "IP-based (~city)")
        );
        markers.push(marker);
    });

    if (markers.length > 0) {
        var group = L.featureGroup(markers);
        map.fitBounds(group.getBounds().pad(0.3));
        if (markers.length === 1) map.setZoom(12);
    }
})();
</script>
{% endif %}

<script>
var deleteBtn = document.getElementById("delete-btn");
if (deleteBtn) {
    deleteBtn.addEventListener("click", async function () {
        if (!confirm("Delete this link and all its scan data?")) return;
        var resp = await fetch("/api/links/" + {{ link.slug | tojson }}, { method: "DELETE" });
        if (resp.ok) {
            window.location.href = "/dashboard";
        } else {
            alert("Failed to delete.");
        }
    });
}
</script>

</body>
</html>
