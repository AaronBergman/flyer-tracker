<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Link Tracker</title>
    <link rel="icon" type="image/png" href="/static/icon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,400;12..96,600;12..96,700;12..96,800&family=JetBrains+Mono:wght@400;500&family=Source+Serif+4:ital,opsz,wght@0,8..60,400;0,8..60,600;1,8..60,400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>

<header>
    <div class="container">
        <div class="header-nav">
            <a href="/dashboard" class="logo">
                <img src="/static/icon.png" alt="" class="logo-icon">
                <span class="logo-text">Link Tracker</span>
            </a>
        </div>
    </div>
</header>

<main class="container">
    <section class="hero animate-in">
        <p>Create tracking links. When someone visits, their location and time are logged automatically.</p>
        <button class="btn" id="create-toggle">+ New Link</button>
    </section>

    <section id="create-section" style="display:none">
        <div class="create-inner">
            <form id="create-form">
                <label>
                    Slug
                    <small>Short code for the URL. Leave blank to auto-generate.</small>
                    <input type="text" name="slug" placeholder="e.g. test1" pattern="[a-z0-9\-]*">
                </label>
                <label>
                    Description
                    <small>Optional note about this link.</small>
                    <input type="text" name="description" placeholder="e.g. posted on 4th and Main">
                </label>
                <button type="submit" class="btn">Create Link</button>
            </form>
            <div id="result"></div>
        </div>
    </section>

    <section class="animate-in animate-in-2">
        <h2>Your Links</h2>
        {% if links %}
        <div class="table-wrap">
            <table>
                <thead>
                    <tr>
                        <th>Slug</th>
                        <th>Description</th>
                        <th>Scans</th>
                        <th>Created</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    {% for link in links %}
                    <tr>
                        <td class="slug-cell">
                            <a href="/dashboard/{{ link.slug }}">{{ link.slug }}</a>
                        </td>
                        <td>{{ link.description or "\u2014" }}</td>
                        <td>
                            <span class="badge {{ 'badge-active' if scan_counts.get(link.id, 0) > 0 }}">
                                {{ scan_counts.get(link.id, 0) }}
                            </span>
                        </td>
                        <td>{{ link.created_at.strftime('%b %d, %Y') }}</td>
                        <td>
                            <span class="link-actions">
                                <button class="icon-btn copy-btn" data-url="{{ base_url }}/t/{{ link.slug }}" title="Copy tracking URL">&#x2398;</button>
                                <a class="icon-btn" href="{{ base_url }}/t/{{ link.slug }}" target="_blank" rel="noopener" title="Open in new tab">&#x2197;</a>
                            </span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="empty-state">No tracking links yet. Create one above to get started.</p>
        {% endif %}
    </section>
</main>

<script>
    var toggleBtn = document.getElementById("create-toggle");
    var createSection = document.getElementById("create-section");

    toggleBtn.addEventListener("click", function () {
        if (createSection.style.display === "none") {
            createSection.style.display = "block";
            createSection.style.animation = "fadeInUp 0.3s ease-out";
            createSection.querySelector("input").focus();
            toggleBtn.textContent = "Cancel";
            toggleBtn.classList.add("btn-outline");
        } else {
            createSection.style.display = "none";
            toggleBtn.textContent = "+ New Link";
            toggleBtn.classList.remove("btn-outline");
        }
    });

    document.getElementById("create-form").addEventListener("submit", async function (e) {
        e.preventDefault();
        var form = e.target;
        var data = Object.fromEntries(new FormData(form));
        var resultEl = document.getElementById("result");

        var resp = await fetch("/api/links", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
        });

        if (resp.ok) {
            var json = await resp.json();
            var trackingUrl = window.location.origin + json.tracking_url;
            resultEl.className = "result-success";
            resultEl.innerHTML =
                "<p><strong>Created!</strong> Tracking URL:</p>" +
                "<p><code>" + trackingUrl + "</code></p>";
            form.reset();
            setTimeout(function () { location.reload(); }, 2000);
        } else {
            var json = await resp.json();
            resultEl.className = "result-error";
            resultEl.innerHTML =
                "<p>" + (json.error || "Something went wrong") + "</p>";
        }
    });

    document.querySelectorAll(".copy-btn").forEach(function (btn) {
        btn.addEventListener("click", function () {
            var url = btn.getAttribute("data-url");
            navigator.clipboard.writeText(url).then(function () {
                btn.classList.add("copied");
                btn.innerHTML = "&#x2713;";
                setTimeout(function () {
                    btn.classList.remove("copied");
                    btn.innerHTML = "&#x2398;";
                }, 1500);
            });
        });
    });
</script>

</body>
</html>
